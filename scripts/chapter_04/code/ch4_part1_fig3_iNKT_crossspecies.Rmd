---
title: "Chapter 4 - Cross-species iNKT"
author: "Salom√© Carcy"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true

---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 5, fig.height = 5,
                      warning=FALSE, message=FALSE,
                      root.dir = "~/Projects/phd/")
```


# IMPORT

## Import librairies
```{r import-librairies}
library(ggplot2)
library(RColorBrewer)
library(cowplot)
library(tidyverse)
library(dplyr)
library(Seurat)
library(SCpubr)
library(patchwork)

source("~/Projects/phd/scripts/colors_universal.R")
```

## Import data
```{r import-data}
# Seurat objects
seur_hu_thym <- list(
  "nkt"=readRDS("./data/seurat_objects/thymus_objects/seurat_thymus_nkt_with_gene_signatures.rds"),
  "mait"=readRDS("./data/seurat_objects/thymus_objects/seurat_thymus_mait_with_gene_signatures.rds"),
  "gdt"=readRDS("./data/seurat_objects/thymus_objects/seurat_thymus_gdt_with_gene_signatures.rds")
)

seur_ms_thym <- list(
  "nkt"=readRDS("./data/seurat_objects/harshakrovi2020/ms_nkt_seurobj.rds"),
  "mait"=readRDS("./data/seurat_objects/legoux2019/ms_mait_seurobj.rds"),
  "gdt"=readRDS("./data/seurat_objects/lee2020/ms_gdt_seurobj_lee.rds")
)

# Orthologs table
ortholog.df <- read.csv("~/Projects/phd/data/cross_species/ortholog_table_ms_hu_one2one.csv")
```




# FUNCTIONS
```{r define-functions}
lineage_genesignature <- function(seuratobj, genesignature, file_name="no"){
  p <- ggrastr::rasterise(
    do_FeaturePlot(
    seuratobj,
    features = genesignature,
    min.cutoff=0,
    use_viridis = T,
    viridis.palette = "E",
    legend.position="right",
    order=T,
    pt.size = 1.5,
    raster=F
    # raster.dpi=2048,
    # pt.size=10
  ),
  layers="Point",
  dpi=300
  )
  print(p)
  if(file_name != "no"){
    ggsave(paste0("~/Projects/phd/data/figures/chapter_04/figs_unfinished/section1/", file_name),
           plot=p,
           width=9, height=6)
  }
}
```




# iNKT FIGURE

## iNKT UMAPs
```{r inkt-umap-mouse}
seur_ms_thym$nkt$cell_type <- factor(seur_ms_thym$nkt$cell_type, levels=c(
  "Stage0",
  "iNKTp",
  "iNKT2",
  "iNKT17",
  "iNKT1"
))

ggrastr::rasterise(
  DimPlot(seur_ms_thym$nkt, group.by="cell_type", cols=cols_harsha_ms),
  layers="Point",
  dpi=300
  ) +
  labs(title="Mouse")+
  theme(
    axis.ticks=element_blank(),
    axis.text=element_blank(),
    axis.line = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=1),
    axis.title=element_text(hjust=0)
    )
# ggsave("./data/figures/chapter_04/figs_unfinished/section1/ch4_fig3_inkt_umap_mouse.pdf", width=6, height=5)
```

```{r inkt-umap-human}
ggrastr::rasterise(
  DimPlot(seur_hu_thym$nkt, group.by="clusters_per_lineage", cols=cols_thym_nkt),
  layers="Point",
  dpi=300
  ) +
  labs(title="Human")+
  theme(
    axis.ticks=element_blank(),
    axis.text=element_blank(),
    axis.line = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=1),
    axis.title=element_text(hjust=0)
    )
# ggsave("./data/figures/chapter_04/figs_unfinished/section1/ch4_fig3_inkt_umap_human.pdf", width=6.5, height=5)
```


## iNKT stages DotPlot
```{r inkt-stages-dotplot, fig.height=6}
# Mouse
do_DotPlot(
  seur_ms_thym$nkt,
  group.by="cell_type",
  features=c("Cd4", "Cd8a", "Cd8b1", "Cd24a", "Cd44", "Klrb1c", "Cd27"),
  flip=T,
  use_viridis = T,
  viridis.palette="B"
)+
  theme(axis.text.y=element_text(face="italic"))
# ggsave("./data/figures/chapter_04/figs_unfinished/section1/ch4_fig3_inkt_stages_dotplot_mouse.pdf", width=4, height=5)

# Human
do_DotPlot(
  seur_hu_thym$nkt,
  group.by="clusters_per_lineage",
  features=c("CD4", "CD8A", "CD8B", "CD24", "CD44", "KLRB1", "CD1C", "CD27"),
  flip=T,
  use_viridis = T,
  viridis.palette="B"
)+
  theme(axis.text.y=element_text(face="italic"))
# ggsave("./data/figures/chapter_04/figs_unfinished/section1/ch4_fig3_inkt_stages_dotplot_human.pdf", width=4, height=5)
```


## iNKT functional stages DotPlot
Here we select genes that define each mouse cluster based on [Harsha Krovi et al. 2020](https://www.nature.com/articles/s41467-020-20073-8) and [Baranek et al.](https://www.sciencedirect.com/science/article/pii/S2211124720311050). These are not "marker genes" _per se_, as we didn't obtain them by computing the most DE genes in each cluster. Instead we selected the genes highlighted in the literature as defining each iNKT developmental stage.
```{r inkt-marker-genes1}
marker_genes_inkt_ms <- c(
  # iNKT0
  "Cd24a",
  "Cd69",
  "Egr2",
  "Hivep3",
  # iNKTp
  "Cdk1",
  "Mki67",
  # Immature & iNKT2
  "Ccr9",
  "Lef1",
  "Slamf6",
  "Gata3",
  "Il4",
  "Ccr7",
  # "Plac8",
  # "Izumo1r",
  "Il6ra",
  # Maturation
  "Zbtb16",
  "Cd44",
  # iNKT17
  "Rorc",
  "Rora",
  "Il17re",
  "Ccr6",
  "Tmem176a",
  # iNKT1
  "Tbx21",
  "Eomes",
  "Klrb1c",
  "Ifng",
  "Prf1",
  "Xcl1",
  # "Il2rb",
  # "Slamf7",
  # Exit
  "Klf2",
  "S1pr1"
)

marker_genes_inkt_hu <- c(
  # iNKT0
  "CD24",
  "CD69",
  "EGR2",
  "HIVEP3",
  # iNKTp
  "CDK1",
  "MKI67",
  # Immature & iNKT2
  "CCR9",
  "LEF1",
  "SLAMF6",
  "GATA3",
  "IL4",
  "CCR7",
  "IL6R",
  # Maturation
  "ZBTB16",
  "CD44",
  # iNKT17
  "RORC",
  "RORA",
  "IL17RE",
  "CCR6",
  "TMEM176A",
  # iNKT1
  "TBX21",
  "EOMES",
  "KLRB1",
  "IFNG",
  "PRF1",
  "XCL1",
  # Exit
  "KLF2",
  "S1PR1"
)


```

```{r inkt-marker-genes2, fig.height=8, fig.width=4}
do_DotPlot(
  seur_ms_thym$nkt,
  group.by="cell_type",
  features=marker_genes_inkt_ms,
  scale=F,
  flip=T,
  use_viridis = T,
  viridis.palette="B"
)+
  theme(axis.text.y=element_text(face="italic"))
# ggsave("./data/figures/chapter_04/figs_unfinished/section1/ch4_fig3_inkt_stages_bigdotplot_mouse.pdf", width=4, height=7)

do_DotPlot(
  seur_hu_thym$nkt,
  group.by="clusters_per_lineage",
  features=marker_genes_inkt_hu,
  flip=T,
  use_viridis = T,
  viridis.palette="B"
)+
  theme(axis.text.y=element_text(face="italic"))
# ggsave("./data/figures/chapter_04/figs_unfinished/section1/ch4_fig3_inkt_stages_bigdotplot_human.pdf", width=4, height=7)
```



## iNKT gene signature
```{r inkt-gene-signatures-mouse, fig.height=8, fig.width=8}
harshakrovi_supptable <- read.csv("./data/litterature_gene_signatures/harshakrovi_tableS1.csv", skip=1)[,2:8]
harshakrovi_supptable <- harshakrovi_supptable %>%
  # keep only iNKT1, 2, 17 clusters (c4-10)
  filter(cluster %in% 4:10) %>%
  filter(p_val_adj < 0.05) %>%
  # cluster to iNKT subset
  mutate(inkt=case_when(
    cluster==4 ~ "iNKT2",
    cluster==5 ~ "iNKT17",
    cluster %in% 6:10 ~ "iNKT1"
    )) %>%
  # get DE genes per iNKT subset
  select(gene, inkt) %>%
  distinct()
# write_csv(harshakrovi_supptable, "~/Downloads/inkt_signatures.csv")

# make it into a list
harshakrovi_gene_signature_list <- lapply(split(harshakrovi_supptable, harshakrovi_supptable$inkt), function(x) x$gene)
names(harshakrovi_gene_signature_list) <- paste0("harshakrovi_", names(harshakrovi_gene_signature_list))
harshakrovi_gene_signature_list <- lapply(harshakrovi_gene_signature_list, function(x) x[x!=""]) # remove empty genes
harshakrovi_gene_signature_list <- lapply(harshakrovi_gene_signature_list, function(x) x[x %in% rownames(seur_ms_thym$nkt)]) # remove genes not found in our data
lapply(harshakrovi_gene_signature_list, function(x) length(x)) # sanity check (0 genes per signature lost)

# Score
seur_ms_thym$nkt <- AddModuleScore(
  object = seur_ms_thym$nkt,
  assay = "RNA",
  features = harshakrovi_gene_signature_list,
  name=names(harshakrovi_gene_signature_list),
  seed=1
  )
colnames(seur_ms_thym$nkt@meta.data)[8:10] <- names(harshakrovi_gene_signature_list)

# Plot and save
lineage_genesignature(
  seuratobj = seur_ms_thym$nkt,
  # file_name = "ch4_fig3_inkt_signatureNKT1_mouse.pdf",
  genesignature = "harshakrovi_iNKT1"
  )
lineage_genesignature(
  seuratobj = seur_ms_thym$nkt,
  # file_name = "ch4_fig3_inkt_signatureNKT2_mouse.pdf",
  genesignature = "harshakrovi_iNKT2"
  )
lineage_genesignature(
  seuratobj = seur_ms_thym$nkt,
  # file_name = "ch4_fig3_inkt_signatureNKT17_mouse.pdf",
  genesignature = "harshakrovi_iNKT17"
)
```


```{r inkt-gene-signatures-human, fig.height=8, fig.width=8}
# check how many genes in gene signature we can find in ortholog table
lapply(harshakrovi_gene_signature_list, function(x) table(x %in% ortholog.df$ms_symbol, useNA="ifany")) # careful, 78 genes from iNKT1 not found in ortholog table (make sure that goes down when updating ortholog table!!!!!)

# More than 80% of genes in gene signatures can be found in ortholog table, so let's translate them
harshakrovi_gene_signature_list_humangenes <- lapply(harshakrovi_gene_signature_list, function(x) ortholog.df %>% filter(ms_symbol %in% x) %>% pull(hu_symbol))
harshakrovi_gene_signature_list_humangenes <- lapply(harshakrovi_gene_signature_list_humangenes, function(x) x[x %in% rownames(seur_hu_thym$nkt)]) # remove genes not found in our data
lapply(harshakrovi_gene_signature_list_humangenes, function(x) length(x)) # sanity check (between 4-8 genes per signature lost, but still >10 genes per signature left)

seur_hu_thym$nkt <- AddModuleScore(
  object = seur_hu_thym$nkt,
  assay = "RNA",
  features = harshakrovi_gene_signature_list_humangenes,
  name=names(harshakrovi_gene_signature_list_humangenes),
  seed=1
  )
colnames(seur_hu_thym$nkt@meta.data)[49:51] <- names(harshakrovi_gene_signature_list_humangenes)

# Plot and save
lineage_genesignature(
  seuratobj = seur_hu_thym$nkt,
  genesignature = "harshakrovi_iNKT1",
  file_name = "ch4_fig3_inkt_signatureNKT1_human.pdf"
)
lineage_genesignature(
  seuratobj = seur_hu_thym$nkt,
  genesignature = "harshakrovi_iNKT2",
  file_name = "ch4_fig3_inkt_signatureNKT2_human.pdf"
)
lineage_genesignature(
  seuratobj = seur_hu_thym$nkt,
  genesignature = "harshakrovi_iNKT17",
  file_name = "ch4_fig3_inkt_signatureNKT17_human.pdf"
)
```




# SESSION INFO
```{r}
sessionInfo()
```


