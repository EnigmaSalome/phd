---
title: "Chapter 2 - Figure 2"
author: "Salom√© Carcy"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true

---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 5, fig.height = 5,
                      warning=FALSE, message=FALSE,
                      root.dir = "~/Projects/phd/")
```


# IMPORT

## Import librairies
```{r import-librairies}
library(ggplot2)
library(cowplot)
library(tidyverse)
library(dplyr)
library(Seurat)
library(harmony)
library(SCpubr)
library(patchwork)
```

## Import data
```{r import-data}
seur_integrated <- readRDS("./data/seurat_objects/seurat_human_integrated_object_23_12_01.rds")
DimPlot(seur_integrated, reduction="umap_integrated", cols = cols_integrated)
```




# FUNCTIONS
## Feature coexpression
Functions inspired from Seurat `FeaturePlot()` background functions.
```{r function_coexpression}

# Set color matrix
BlendMatrix <- function(
    n = 10,
    col.threshold = 0.5,
    two.colors = c("#ff0000", "#00ff00"),
    negative.color = "black"
) {
  if (0 > col.threshold || col.threshold > 1) {
    stop("col.threshold must be between 0 and 1")
  }
  C0 <- as.vector(col2rgb(negative.color, alpha = TRUE))
  C1 <- as.vector(col2rgb(two.colors[1], alpha = TRUE))
  C2 <- as.vector(col2rgb(two.colors[2], alpha = TRUE))
  blend_alpha <- (C1[4] + C2[4])/2
  C0 <- C0[-4]
  C1 <- C1[-4]
  C2 <- C2[-4]
  merge.weight <- min(255 / (C1 + C2 +  C0 + 0.01))
  sigmoid <- function(x) {
    return(1 / (1 + exp(-x)))
  }
  blend_color <- function(
    i,
    j,
    col.threshold,
    n,
    C0,
    C1,
    C2,
    alpha,
    merge.weight
  ) {
    c.min <- sigmoid(5 * (1 / n - col.threshold))
    c.max <- sigmoid(5 * (1 - col.threshold))
    c1_weight <- sigmoid(5 * (i / n - col.threshold))
    c2_weight <- sigmoid(5 * (j / n - col.threshold))
    c0_weight <-  sigmoid(5 * ((i + j) / (2 * n) - col.threshold))
    c1_weight <- (c1_weight - c.min) / (c.max - c.min)
    c2_weight <- (c2_weight - c.min) / (c.max - c.min)
    c0_weight <- (c0_weight - c.min) / (c.max - c.min)
    C1_length <- sqrt(sum((C1 - C0) ** 2))
    C2_length <- sqrt(sum((C2 - C0) ** 2))
    C1_unit <- (C1 - C0) / C1_length
    C2_unit <- (C2 - C0) / C2_length
    C1_weight <- C1_unit * c1_weight
    C2_weight <- C2_unit * c2_weight
    C_blend <- C1_weight * (i - 1) * C1_length / (n - 1) + C2_weight * (j - 1) * C2_length / (n - 1) + (i - 1) * (j - 1) * c0_weight * C0 / (n - 1) ** 2 + C0
    C_blend[C_blend > 255] <- 255
    C_blend[C_blend < 0] <- 0
    return(rgb(
      red = C_blend[1],
      green = C_blend[2],
      blue = C_blend[3],
      alpha = alpha,
      maxColorValue = 255
    ))
  }
  blend_matrix <- matrix(nrow = n, ncol = n)
  for (i in 1:n) {
    for (j in 1:n) {
      blend_matrix[i, j] <- blend_color(
        i = i,
        j = j,
        col.threshold = col.threshold,
        n = n,
        C0 = C0,
        C1 = C1,
        C2 = C2,
        alpha = blend_alpha,
        merge.weight = merge.weight
      )
    }
  }
  return(blend_matrix)
}

# Plot color matrix
Melt <- function(x) {
  if (!is.data.frame(x = x)) {
    x <- as.data.frame(x = x)
  }
  return(data.frame(
    rows = rep.int(x = rownames(x = x), times = ncol(x = x)),
    cols = unlist(x = lapply(X = colnames(x = x), FUN = rep.int, times = nrow(x = x))),
    vals = unlist(x = x, use.names = FALSE)
  ))
}

BlendMap <- function(color.matrix, step=2, xtext='rows', ytext="cols") {
  color.heat <- matrix(
    data = 1:prod(dim(x = color.matrix)) - 1,
    nrow = nrow(x = color.matrix),
    ncol = ncol(x = color.matrix),
    dimnames = list(
      1:nrow(x = color.matrix),
      1:ncol(x = color.matrix)
    )
  )
  
  # xbreaks <- seq.int(from = 0, to = nrow(x = color.matrix), by = step)
  # ybreaks <- seq.int(from = 0, to = ncol(x = color.matrix), by = step)
  color.heat <- Melt(x = color.heat)
  color.heat$rows <- as.numeric(x = as.character(x = color.heat$rows))
  color.heat$cols <- as.numeric(x = as.character(x = color.heat$cols))
  color.heat$vals <- factor(x = color.heat$vals)
  plot <- ggplot(
    data = color.heat,
    mapping = aes_string(x = "rows", y = "cols", fill = 'vals')
  ) +
    geom_raster(show.legend = FALSE) +
    theme(plot.margin = unit(x = rep.int(x = 0, times = 4), units = 'cm')) +
    # scale_x_continuous(breaks = xbreaks, expand = c(0, 0), labels = xbreaks) +
    # scale_y_continuous(breaks = ybreaks, expand = c(0, 0), labels = ybreaks) +
    scale_fill_manual(values = as.vector(x = color.matrix)) +
    labs(x=xtext, y=ytext)+
    theme_cowplot()
  
  if(step!=0){
    xbreaks <- seq.int(from = 0, to = nrow(x = color.matrix), by = step)
    ybreaks <- seq.int(from = 0, to = ncol(x = color.matrix), by = step)
    plot <- plot +
      scale_x_continuous(breaks = xbreaks, expand = c(0, 0), labels = xbreaks) +
      scale_y_continuous(breaks = ybreaks, expand = c(0, 0), labels = ybreaks)
  } else if(step==0){
    plot <- plot+theme(axis.text=element_blank(), axis.ticks=element_blank())
  }
  
  return(plot)
}

# Normalize expression level of 2 features & return also a "blend" expression (corresponding to color matrix)
BlendExpression <- function(data, nlevels=100) {
  if (ncol(x = data) != 2) {
    stop("'BlendExpression' only blends two features")
  }
  features <- colnames(x = data)
  data <- as.data.frame(x = apply(
    X = data,
    MARGIN = 2,
    FUN = function(x) {
      return(round(x = (nlevels-1) * (x - min(x)) / (max(x) - min(x))))
    }
  ))
  data[, 3] <- data[, 1] + data[, 2] * nlevels
  # colnames(x = data) <- c(features, paste(features, collapse = '_'))
  colnames(x = data) <- c(features, "blend")
  for (i in 1:ncol(x = data)) {
    data[, i] <- factor(x = data[, i])
  }
  return(data)
}

PlotCoexpression <- function(seuratobj,
                             features,
                             features_origin="metadata",
                             plotting="blend",
                             pwithmatrix=T,
                             rasterdpi=300,
                             nlevels=100,
                             cols.neg="#969696", cols.pos=c("#74c476", "#fd8d3c"),
                             col.threshold=0.5, colmatrix_stepsize=10,
                             order=T){
  # GET COLOR MATRIX
  cat("\n-> Getting color matrix\n")
  color.matrix <- BlendMatrix(
    two.colors = cols.pos,
    col.threshold = col.threshold,
    negative.color = cols.neg,
    n=nlevels
  )
  
  # DEFINE COLOR LIST FOR PLOTTING
  cat("\n-> Defining colors for plotting\n")
  colors <- list(
    color.matrix[, 1], # red
    color.matrix[1, ], # green
    as.vector(x = color.matrix)
  )
  
  # BLEND EXPRESSION
  cat("\n-> Blending features expression\n")
  if(features_origin=="metadata"){df <- seuratobj@meta.data[, features]}
  else if(features_origin=="data"){df <- t(as.data.frame(seuratobj@assays$RNA@data[features,]))}
  df <- BlendExpression(df, nlevels=nlevels) # 3 columns
  # head(df)
  # GET PLOTTING DATAFRAME
  cat("\n-> Defining plotting DF\n")
  dims <- seuratobj@reductions$umap@cell.embeddings
  # head(dims)
  df_final <- cbind(df, dims, seuratobj@meta.data[,"clusters_integrated_data"])
  colnames(df_final)[6] <- "clusters"
  # head(df_final)
  
  # PLOT
  if(plotting=="feature1"){
    cat("\n-> Plotting feature 1\n")
    if(order==T){df_final <- df_final[order(df_final[,1]),]}
    df_final[,1] <- as.numeric(as.character(df_final[,1])) # transform factors to numbers for plotting
    p <- ggplot(df_final, aes_string(x=colnames(dims)[1], y=colnames(dims)[2], color=colnames(df_final)[1]))+
      geom_point(size=0.1)+
      scale_color_gradient(low=color.matrix[1, 1], high=color.matrix[nrow(color.matrix), 1])
  }
  else if(plotting=="feature2"){
    cat("\n-> Plotting feature 2\n")
    if(order==T){df_final <- df_final[order(df_final[,2]),]}
    df_final[,2] <- as.numeric(as.character(df_final[,2])) # transform factors to numbers for plotting
    p <- ggplot(df_final, aes_string(x=colnames(dims)[1], y=colnames(dims)[2], color=colnames(df_final)[2]))+
      geom_point(size=0.1)+
      scale_color_gradient(low=color.matrix[1, 1], high=color.matrix[1, ncol(color.matrix)])
  }
  else if(plotting=="blend"){
    cat("\n-> Plotting blended features\n")
    if(order==T){df_final <- df_final[order(df_final[,1], df_final[,2]),]} # order points by increasing value of score 1 and score 2
    # df_final[,3] <- as.numeric(as.character(df_final[,3])) # transform factors to numbers for plotting
    # Colors
    cols.use <- as.vector(color.matrix)
    names(cols.use) <- as.character(0:(length(cols.use)-1))
    # Plot
    p <- ggplot(df_final, aes_string(x=colnames(dims)[1], y=colnames(dims)[2], color=colnames(df_final)[3]))+
      geom_point(size=0.3)+
      scale_color_manual(values=cols.use)+
      labs(x="UMAP1", y="UMAP2")+
      theme_cowplot()+
      theme(legend.position="none",
            axis.text=element_blank(),
            axis.title=element_blank(),
            axis.ticks = element_blank(),
            axis.line = element_blank(),
            panel.border=element_rect(color="white", fill=NA, size=1))
    # rasterise to avoid computer crashing
    p <- ggrastr::rasterise(p, layers="Point", dpi=rasterdpi)
    # add color matrix if specified
    if(pwithmatrix==T){
      cat("\n-> Adding color matrix on plot\n")
      p <- ggdraw(p)+
        draw_plot(BlendMap(color.matrix, step=colmatrix_stepsize, xtext=features[1], ytext=features[2]),
                  0.05,0.06,.25,.25)
    }
  }
  
  return(p)
}
```




# FIGURES
## Figure 2: integrated data by tissue
Show the cells colored by tissue. Split by tissue to show overlap.
```{r fig2, fig.width=5, fig.height=5}
# order thymus first
seur_integrated@meta.data$tissue <- factor(seur_integrated@meta.data$tissue, levels=c("Thymus", "PBMC"))

do_DimPlot(
  seur_integrated,
  group.by="tissue",
  split.by="tissue",
  colors.use=cols_tissue,
  shuffle=T,
  order=NULL,
  pt.size=4,
  border.size=2,
  raster=T,
  raster.dpi = 2048
  )
# ggsave("~/Projects/phd/scripts/chapter_02/figs/figs_unfinished/ch2_fig2_bis.jpeg", width=12, height=5)
```




## Figure 3: expected Tconv dvlpmt
Generated with ShinyCell for simplicity (can try later to put it in this notebook)
```{r fig3, fig.width=4, fig.height=4}
# PlotCoexpression(
#   seuratobj=seur_integrated,
#   features=c("CD4", "CD8A"),
#   features_origin="data",
#   cols.neg = "lightgrey",
#   cols.pos=c("darkred", "darkblue"),
#   order=T
#   )
# 
# PlotCoexpression(
#   seuratobj=seur_integrated,
#   features=c("ZBTB7B", "RUNX3"),
#   features_origin="data",
#   cols.neg = "lightgrey",
#   cols.pos=c("darkred", "darkblue"),
#   order=T
#   )
```

```{r fig3_CD4_CD8_cellhashing, fig.width=4, fig.height=4}
Idents(seur_integrated) <- "tcell_lineage_tissue"

do_DimPlot(
    sample = seur_integrated,
    idents.keep=c("CD4_Thymus", "CD8_Thymus"),
    colors.use = c("CD4_Thymus"="#74c476", "CD8_Thymus"="#df65b0"),
    pt.size=4,
    raster=T,
    raster.dpi = 2048
)
# ggsave("~/Projects/phd/scripts/chapter_02/figs/figs_unfinished/ch2_fig3_cd4cd8_cellhashing.jpeg", width=6, height=6)
```


```{r fig3_Tconv_gene_exp, fig.width=10, fig.height=10}
# genes_to_plot <- c("RAG1", "PTCRA", "CD4", "CD8A", "CD8B", "ZBTB7B", "RUNX3", "CCR9", "CCR7", "FOXP3", "GNG4", "TRGC1")
genes_to_plot <- c("RAG1", "CD4", "CD8A", "CD8B", "ZBTB7B", "CD40LG", "RUNX3", "LINC02446")

# Expression of key Tconv genes
for(gene in genes_to_plot){
  print(gene)
  SCpubr::do_FeaturePlot(
    sample = seur_integrated,
    slot="data",
    cells.highlight=rownames(seur_integrated@meta.data[seur_integrated@meta.data$tissue=="Thymus",]),
    features = gene,
    use_viridis=T,
    viridis.palette = "B",
    legend.position="right",
    order=T,
    pt.size=1
    # raster=T,
    # raster.dpi = 2048
  )
  ggsave(paste0("~/Projects/phd/scripts/chapter_02/figs/figs_unfinished/ch2_fig3_", gene, ".jpeg"),
         width=8, height=7)
}
```




## Figure 4: expected agonist-selected T dvlpmt (CD8aa & Treg)
```{r fig4_keygenes, fig.width=5, fig.height=5}
genes_to_plot <- c("GNG4", "FOXP3", "CTLA4")

for(gene in genes_to_plot){
  print(gene)
  SCpubr::do_FeaturePlot(
    sample = seur_integrated,
    slot="data",
    cells.highlight=rownames(seur_integrated@meta.data[seur_integrated@meta.data$tissue=="Thymus",]),
    features = gene,
    use_viridis=T,
    viridis.palette = "B",
    legend.position="right",
    order=T,
    pt.size=1
    # raster=T,
    # raster.dpi = 2048
  )
  # ggsave(paste0("~/Projects/phd/scripts/chapter_02/figs/figs_unfinished/ch2_fig4_", gene, ".jpeg"),
  #        width=8, height=7)
}
```

```{r fig4_parksignatures, fig.width=6, fig.height=5}
# Get Park et al. gene signatures
park_markergenes <- read.csv("~/Projects/phd/data/litterature_gene_signatures/park_genesignatures.csv", row.names=1)

# add module score
gene_signatures <- c("CD8aa1", "CD8aa2", "Treg", "Treg_diff", "T_agonist")
gene_signatures_list <- as.list(park_markergenes[,gene_signatures])
seur_integrated <- AddModuleScore(object = seur_integrated, assay = "RNA",
                                  features = gene_signatures_list, name=gene_signatures)
colnames(seur_integrated@meta.data)[32:36] <- gene_signatures

# plot
gene_signatures_to_plot <- c("T_agonist", "CD8aa1", "Treg_diff", "Treg")
for(sig in gene_signatures_to_plot){
  print(sig)
  do_FeaturePlot(
    sample = seur_integrated,
    slot="data",
    cells.highlight=rownames(seur_integrated@meta.data[seur_integrated@meta.data$tissue=="Thymus",]),
    features = sig,
    use_viridis=T,
    viridis.palette = "E", #E, G
    legend.position="right",
    order=T,
    pt.size=1
  )
  # ggsave(paste0("~/Projects/phd/scripts/chapter_02/figs/figs_unfinished/ch2_fig4_park_", sig, ".jpeg"),
  #        width=8, height=7)
}
```




## Figure 5: integrated clustering
```{r fig5_clusters, fig.width=5, fig.height=5}
# All data
do_DimPlot(
    sample = seur_integrated,
    group.by="clusters_integrated_data",
    colors.use = cols_integrated,
    label=T,
    legend.position="none",
    pt.size=4,
    raster=T,
    raster.dpi = 2048
)
# ggsave("~/Projects/phd/scripts/chapter_02/figs/figs_unfinished/ch2_fig5_clusters.jpeg", width=6, height=6)
```

```{r fig5_clusters_by_tissue, fig.width=20, fig.height=5}
# Highlight thymocytes
do_DimPlot(
    sample = seur_integrated,
    group.by="clusters_integrated_data",
    split.by="tissue",
    colors.use = cols_integrated,
    legend.position="none",
    pt.size=4,
    raster=T,
    raster.dpi = 2048
)
# ggsave("~/Projects/phd/scripts/chapter_02/figs/figs_unfinished/ch2_fig5_clusters_by_tissue.jpeg", width=18, height=6)
```

```{r fig5_markergenes, fig.height=10, fig.width=8}
# Supp Fig 3A, but only on thymocytes
thymocytes_cellid <- rownames(seur_integrated@meta.data[seur_integrated@meta.data$tissue=="Thymus",])
length(thymocytes_cellid)

genes_dotplot <- c(
  "PTCRA", "RAG1", # CD4 ISP
  "MKI67", "CDK1", # CD4 ISP (P)
  "CD4", "CD8A", "CD8B", "CD1C", "AQP3", # DP
  "CCR9", "SATB1", # ab T entry
  "EGR1", "EGR3", "NR4A1", # Agonist
  "CD8A", "PDCD1", "GNG4", # CD8aa
  "TRDC", "TRGC2", # GD
  "IKZF4", "FOXP3", "CTLA4", "IL2RA", # Treg
  "STAT1", "IFI6", # IFN sig
  "CD8B", "RUNX3", "LINC02446", # CD8
  "CD4", "ZBTB7B", "CD40LG", # CD4
  "CCR7", "SELL", "S1PR1",  #"IL7R", # Naive / exit
  "FOS", "JUN", "JUNB", # AP1 signaling
  "EOMES", "TBX21", "RORA", "RORC", "GZMK", "GZMB", "GNLY", "PRF1", "NKG7", "KLRB1", "IFNG", "CCR6" # Effector
  )

# DotPlot
fig5_p1 <- do_DotPlot(
  sample=seur_integrated[,thymocytes_cellid],
  features=genes_dotplot,
  group.by = "clusters_integrated_data",
  legend.position = "right",
  use_viridis = T,
  viridis.palette = "B",
  flip=T
  )+
  # coord_flip()+
  theme(axis.text.x=element_text(angle=0, hjust=0.5),
        axis.text.y=element_text(face="italic"))

# Barplot of nb of cells
fig5_p2 <- seur_integrated@meta.data %>%
  as_data_frame() %>%
  filter(tissue=="Thymus") %>%
  group_by(clusters_integrated_data, tcell_lineage) %>%
  count() %>%
  ggplot(aes(x=clusters_integrated_data, y=n, fill=tcell_lineage))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=cols_lineages, name="Cell hashing")+
  scale_y_continuous(expand = c(0, 0))+
  # scale_x_discrete(position="top")+
  labs(x="", y="Number of thymocytes")+
  theme_cowplot()

# Combine
fig5_p2 / fig5_p1 + plot_layout(heights = c(1, 4))
# ggsave("~/Projects/phd/scripts/chapter_02/figs/figs_unfinished/ch2_fig5_markergenes.pdf", width=8, height=10)
```

```{r fig5_tissue_distribution}
seur_integrated@meta.data %>%
  as_data_frame() %>%
  group_by(clusters_integrated_data, tissue) %>%
  count() %>%
  mutate(tissue=as.character(tissue)) %>%
  # plot
  ggplot(aes(x=clusters_integrated_data, y=n, fill=tissue))+
  geom_bar(stat="identity", position="fill")+
  scale_fill_manual(values=cols_tissue, name="Tissue")+
  theme_cowplot()+
  labs(x="Clusters", y="Frequency")
# ggsave("~/Projects/phd/scripts/chapter_02/figs/figs_unfinished/ch2_fig5_tissue_distribution.pdf", width=7, height=4)
```












# SESSION INFO
```{r}
sessionInfo()
```


